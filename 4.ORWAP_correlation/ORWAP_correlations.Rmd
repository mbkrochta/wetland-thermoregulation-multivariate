---
title: "SiteScoresCompare"
author: "Michael Krochta"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(readxl)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
```

**Subscore correlations**
```{r}
# Define the functional attributes (normalized subscores)
score_cols <- c("WoodyDryShade_Norm", "EmPct_Norm", "Gcover_Norm",
                "WoodyPct_Norm", "DepthDom_Norm", "PondWpctDry_Norm", "Total_Norm")

# Create clean labels for y-axis
score_labels <- c(
  "WoodyDryShade_Norm" = "Shade",
  "EmPct_Norm" = "Emergent vegetation",
  "Gcover_Norm" = "Ground cover",
  "WoodyPct_Norm" = "Woody vegetation",
  "DepthDom_Norm" = "Depth",
  "PondWpctDry_Norm" = "Ponded water",
  "Total_Norm" = "Total"
)

# Function to calculate Spearman's rho and p-values
get_spearman <- function(df, cols, outcome, label) {
  result <- lapply(cols, function(col) {
    test <- cor.test(df[[col]], df[[outcome]], method = "spearman")
    data.frame(
      Score = col,
      Spearman_rho = test$estimate,
      p_value = test$p.value
    )
  })
  bind_rows(result) %>% mutate(Subperiod = label)
}

# Calculate correlations for Sub1 and Sub2
cor_sub1 <- get_spearman(data, score_cols, "Sub1_out", "Sub1")
cor_sub2 <- get_spearman(data, score_cols, "Sub2_out", "Sub2")

cor_df <- bind_rows(cor_sub1, cor_sub2) %>%
  mutate(
    Score = factor(Score, levels = rev(score_cols)),
    Subperiod = factor(dplyr::recode(Subperiod, "Sub1" = "Early", "Sub2" = "Late"),
                       levels = c("Late", "Early"))
  ) %>%
  # Apply multiple-comparison corrections across ALL tests 
  mutate(
    p_adj_bh    = p.adjust(p_value, method = "BH"),          # FDR (Benjamini-Hochberg)
    p_adj_holm  = p.adjust(p_value, method = "holm"),        # Holm step-down
    p_adj_bonf  = p.adjust(p_value, method = "bonferroni")   # Bonferroni
  ) %>%
  # Use BH-adjusted p-values for significance stars in the plot
  mutate(
    sig_label = dplyr::case_when(
      p_adj_bh < 0.001 ~ "***",
      p_adj_bh < 0.01  ~ "**",
      p_adj_bh < 0.05  ~ "*",
      p_adj_bh < 0.1   ~ ".",
      TRUE ~ ""
    )
  )

# Dynamic axis range 
max_rho <- max(cor_df$Spearman_rho, na.rm = TRUE)

# Plot
ggplot(cor_df, aes(x = Spearman_rho, y = Score, fill = Subperiod)) +
  geom_bar(aes(group = Subperiod), stat = "identity",
           position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = sig_label, group = Subperiod),
            position = position_dodge(width = 0.7),
            hjust = 1.2,
            size = 5,
            fontface = "bold") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  scale_fill_manual(
    values = c("Late" = "#33a02c", "Early" = "#1f78b4"),
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_discrete(labels = score_labels) +
  scale_x_continuous(
    breaks = seq(-1, max_rho, by = 0.25),
    limits = c(-1, max_rho + 0.05)
  ) +
  theme_minimal() +
  labs(
    x = "Spearman's Ï",
    y = "Functional Attribute",
    fill = "Period"
  ) +
  theme(
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 11),
    legend.position = "right",
    plot.caption = element_text(size = 9)
  )

# Output table with raw and adjusted p-values
cor_out <- cor_df %>%
  dplyr::select(Score, Subperiod, Spearman_rho, p_value, p_adj_bh, p_adj_holm, p_adj_bonf)

write.csv(cor_out, file = "cor_df.csv", row.names = FALSE)

```


